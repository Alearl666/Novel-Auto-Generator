# 📚 Novel Auto Generator | 小说自动生成器

<div align="center">

[![GitHub tag (latest by date)](https://img.shields.io/github/v/tag/CyrilPeng/Novel-Auto-Generator?sort=semver&label=version&color=blue)](https://github.com/CyrilPeng/Novel-Auto-Generator/tags)
[![SillyTavern](https://img.shields.io/badge/SillyTavern-1.10%2B-green.svg)](https://github.com/SillyTavern/SillyTavern)
[![License](https://img.shields.io/badge/license-MIT-orange.svg)](https://github.com/CyrilPeng/Novel-Auto-Generator/blob/main/LICENSE)

**🚀 一款 SillyTavern 扩展插件，让 AI 自动为你续写小说，解放双手！**

**支持断点续传、智能导出、标签提取、多插件兼容、TXT转世界书等功能**

[功能特性](#-功能特性) •
[快速开始](#-快速开始) •
[使用指南](#-使用指南) •
[TXT转世界书](#-txt转世界书) •
[高级功能](#-高级功能) •
[常见问题](#-常见问题)

</div>

---

## ✨ 功能特性

| 功能 | 描述 |
|:---:|:---|
| ⚡ **自动挂机生成** | 设定章节数，一键开始，自动发送提示词让 AI 持续创作 |
| 💾 **断点续传** | 随时暂停/恢复，进度自动保存，关闭页面也不丢失 |
| 🏷️ **智能标签提取** | 从 AI 回复中精准提取指定 XML 标签内容（如 `<content>`） |
| 📊 **实时统计** | 进度条、已用时间、预计剩余时间、错误统计一目了然 |
| 🔄 **自动重试** | 网络波动？响应过短？自动重试，稳定输出 |
| 📤 **多格式导出** | 支持 TXT / JSON 格式，灵活筛选楼层和消息类型 |
| 💬 **弹窗检测** | 智能检测插件弹窗，完美兼容剧情推进、总结等插件 |
| 📚 **TXT转世界书** | 将TXT小说转换为SillyTavern世界书格式，支持多种AI API |
| 📱 **移动端适配** | 完美支持手机端操作，随时随地挂机生成 |
| ❓ **内置帮助** | 每个设置面板都有详细帮助说明，新手友好 |

---

## 🚀 快速开始

### 安装步骤

1. **安装扩展**
   - 进入 `扩展` → `安装扩展`
   - 输入下面链接并安装：
   ```bash
   https://github.com/CyrilPeng/novel-auto-generator
   ```

2. **开始使用**
   - 启用扩展后，在侧边栏找到 📚 **小说自动生成器**
   - 设置目标章节数和提示词
   - 点击 ▶️ **开始**

---

## 📖 使用指南

### 🎯 基础用法：自动生成小说

```
1️⃣  打开一个角色对话（确保 AI 已有上下文）
     ↓
2️⃣  展开「📚 小说自动生成器」插件面板
     ↓
3️⃣  设置目标章节数（如 100 章）
     ↓
4️⃣  填写提示词（如 "继续"）
     ↓
5️⃣  点击 [▶️ 开始]
     ↓
6️⃣  挂机等待... 自动生成中 ☕
     ↓
7️⃣  完成后自动导出，或随时手动导出
```

### 💡 提示词参考

| 场景 | 提示词示例 |
|:---|:---|
| 简洁版 | 继续 |
| 标准版 | 继续推进剧情，保证流畅自然 |
| 详细版 | 请继续创作下一章，注意人物性格一致性，推进主线剧情 |
| 指定风格 | 继续，增加更多对话描写 |

### 🎛️ 控制按钮说明

| 按钮 | 功能 |
|:---:|:---|
| ▶️ 开始 | 从当前进度开始/继续生成 |
| ⏸️ 暂停 | 暂停生成（当前章节会完成后暂停） |
| ⏯️ 恢复 | 从暂停状态恢复生成 |
| ⏹️ 停止 | 完全停止生成任务 |
| 🔄 重置 | 将进度归零，从头开始 |

---

## 📚 TXT转世界书

### 功能介绍

将TXT小说文件转换为SillyTavern世界书格式，让AI自动提取角色、地点、组织、剧情大纲等信息。

#### 核心特性

| 特性 | 描述 |
|:---:|:---|
| 🤖 **多API支持** | 支持 Gemini、DeepSeek、Gemini代理、OpenAI兼容等多种API |
| 📝 **增量输出** | 智能增量更新，避免重复处理 |
| 🔀 **记忆分裂** | 自动处理Token超限，分裂大块内容 |
| 📜 **历史追踪** | 完整的修改历史记录，支持回滚 |
| 🔧 **AI优化** | 可对生成的世界书进行AI优化 |
| 💾 **断点续传** | 进度自动保存，刷新页面后可继续 |

### 使用方法

```
1️⃣  点击插件面板中的「📚 TXT转世界书」按钮
     ↓
2️⃣  选择API提供商并配置API信息
     ↓
3️⃣  上传TXT小说文件
     ↓
4️⃣  点击「🚀 开始转换」
     ↓
5️⃣  等待AI处理完成
     ↓
6️⃣  导出为JSON或SillyTavern格式
```

### API配置说明

#### Gemini（推荐）
- 直接使用Google Gemini API
- 填写API Key即可
- 默认模型：gemini-2.5-flash

#### Gemini代理
- 使用第三方Gemini代理服务
- 需要填写代理Endpoint和API Key

#### DeepSeek
- 使用DeepSeek官方API
- 填写API Key即可

#### OpenAI兼容
- 支持任何OpenAI兼容的API（如本地模型、第三方服务）
- 填写Endpoint（如 `http://127.0.0.1:5000/v1`）
- 可选填写API Key
- 支持「🔄 拉取模型」自动获取可用模型列表
- 支持「⚡ 快速测试」验证API连接

### 生成内容

世界书将包含以下分类：

| 分类 | 内容 |
|:---:|:---|
| 👤 **角色** | 姓名、性别、年龄、身份、性格、外貌、技能、背景故事等 |
| 📍 **地点** | 名称、位置、特征、重要事件等 |
| 🏛️ **组织** | 名称、性质、成员、目标等 |
| 📖 **剧情大纲** | 主线剧情、支线剧情、关键转折点（可选） |
| 🎨 **文风配置** | 作品文风分析（可选） |

### 导出格式

- **JSON格式**：原始JSON数据，可用于其他用途
- **SillyTavern格式**：直接导入SillyTavern的世界书格式

---

## 🎯 高级功能

### 🏷️ 标签提取

当你使用正则表达式美化 AI 输出时，原始回复可能包含多种标签。
使用**标签提取**功能，可以只导出指定标签内的正文。

```xml
<thinking>这是 AI 的思考过程...</thinking>

<content>
这里是小说正文内容，包含角色对话和情节描写...
</content>

<summary>本章总结...</summary>
```

#### 使用方法

1. ✅ **勾选「原始 (chat.mes)」** — 必须！读取未经正则处理的原始内容
2. 模式选择 **「只提取指定标签」**
3. 填写标签名：`content` 或 `content summary`（多标签用空格/逗号分隔）
4. 点击 **🔄 刷新预览** 确认提取效果
5. 导出时将只包含提取的内容！

#### 多标签提取规则

| 输入方式 | 效果 |
|:---|:---|
| `content` | 只提取 `<content>` 标签 |
| `content summary` | 同时提取两个标签 |
| `content, detail, 正文` | 逗号分隔也可以 |

> 💡 点击标签提取面板的 ❓ 按钮可查看详细帮助

---

### 💬 弹窗检测（插件兼容）

**适用场景**：当你同时使用剧情推进插件、总结插件、记忆插件等时。

**工作原理**：检测页面上的弹窗通知，等待弹窗消失后再继续，确保其他插件处理完成。

#### 两阶段弹窗检测

| 阶段 | 说明 | 典型场景 |
|:----:|:-----|:---------|
| 📤 **发送阶段** | 消息发送后检测 | 剧情推进插件处理消息 |
| 📥 **回复阶段** | AI回复后检测 | 总结插件处理回复内容 |

#### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 等待超时 | 发送60秒/回复5分钟 | 最长等待弹窗消失的时间 |
| 额外等待 | 1-2秒 | 弹窗消失后再额外等待的时间 |

---

### 📤 楼层范围导出

默认导出所有楼层，也可以指定范围：

| 场景 | 设置 |
|------|------|
| 导出全部 | ✅ 勾选「导出全部」|
| 只导出 10-50 楼 | 取消勾选，设置起始=10，结束=50 |
| 只导出最后 100 楼 | 计算楼层号后设置 |

**导出选项**：
- 👤 **用户消息**：是否包含用户发送的内容
- 🤖 **AI 回复**：是否包含 AI 的回复
- 📄 **原始 (chat.mes)**：读取原始内容还是显示内容

> 💡 楼层从 **0** 开始计数，与 SillyTavern 一致

---

### ⚙️ 高级设置

高级设置分为三个模块，清晰明了：

#### 📤 发送阶段
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 弹窗检测 | ✅ 开启 | 检测剧情推进等插件的弹窗 |
| 等待超时 | 60秒 | 最长等待弹窗消失时间 |
| 额外等待 | 1秒 | 弹窗消失后额外等待 |

#### 📥 回复阶段
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 回复后等待 | 5秒 | AI回复稳定后等待，让总结插件启动 |
| 稳定检查间隔 | 1秒 | 检查内容是否稳定的间隔 |
| 稳定次数 | 3次 | 连续多少次不变才算稳定 |
| 弹窗检测 | ✅ 开启 | 检测总结等插件的弹窗 |
| 等待超时 | 5分钟 | 最长等待弹窗消失时间 |
| 额外等待 | 2秒 | 弹窗消失后额外等待 |

#### 🔧 生成控制
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 自动保存间隔 | 50章 | 每生成多少章自动导出备份 |
| 最大重试 | 3次 | 单章失败后的最大重试次数 |
| 最小章节长度 | 100字 | 低于此字数视为失败 |

> 💡 点击高级设置面板的 ❓ 按钮可查看完整参数说明

---

## 📊 工作流程图

```
发送消息
    ↓
[发送阶段弹窗检测] ← 等待剧情推进插件
    ↓
等待AI消息数量增加
    ↓
等待内容稳定 (长度不再变化)
    ↓
固定等待时间
    ↓
[回复阶段弹窗检测] ← 等待总结插件
    ↓
再次稳定性检查
    ↓
检查章节长度 → 通过 → 保存进度 → 下一章
                 ↓
              失败 → 重试 (最多3次)
```

---

## 🔧 调试

在浏览器控制台 (F12) 中可以使用调试命令：

```javascript
// 查看最后一条 AI 消息的原始内容
nagDebug()

// 查看指定楼层的原始内容（如第 5 楼）
nagDebug(5)
```

输出示例：
```
[NovelGen] ✅ chat 获取成功，共 50 条

----- 楼层 49 -----
mes: <content>这里是原始内容...</content>

----- 标签测试 [content] -----
结果: 这里是原始内容...
```

---

## ❓ 常见问题

<details>
<summary><b>Q: 标签提取不生效？</b></summary>

请检查：
1. ✅ 是否勾选了「原始 (chat.mes)」
2. 标签名是否正确（区分大小写）
3. 使用 `nagDebug()` 查看原始内容中是否包含该标签
4. 点击「🔄 刷新预览」查看提取效果

</details>

<details>
<summary><b>Q: 生成过程中频繁报错重试？</b></summary>

可能原因：
- AI 回复过短，未达到最小长度
- 网络波动

解决方案：
- 降低「最小章节长度」要求
- 检查网络连接
- 增加「回复后等待」时间

</details>

<details>
<summary><b>Q: 使用剧情推进/总结插件时出现冲突？</b></summary>

解决方案：
1. 展开「高级设置」面板
2. 在对应阶段 ✅ 勾选「启用弹窗检测」
3. 如果插件处理很慢，可以增加「等待超时」时间
4. 增加「额外等待」时间确保处理完成

</details>

<details>
<summary><b>Q: 导出的内容是空的？</b></summary>

请检查：
1. 是否勾选了「🤖 AI 回复」
2. 楼层范围是否正确
3. 如果使用标签提取，确认标签名是否匹配
4. 使用预览功能确认内容存在

</details>

<details>
<summary><b>Q: 插件面板不显示？</b></summary>

1. 刷新页面
2. 检查浏览器控制台是否有错误
3. 确认扩展已启用
4. 尝试重新安装

</details>

<details>
<summary><b>Q: 如何查看帮助？</b></summary>

每个设置面板标题旁都有 ❓ 帮助按钮，点击即可查看该功能的详细说明。

</details>

<details>
<summary><b>Q: 移动端使用有问题？</b></summary>

v1.2.0 已完美适配移动端：
- 帮助弹窗居中显示
- 关闭按钮加大便于点击
- 修复关闭弹窗时的事件冲突

</details>

<details>
<summary><b>Q: TXT转世界书API报错404？</b></summary>

请检查：
1. API Endpoint是否正确（如 `http://127.0.0.1:5000/v1`）
2. 使用「⚡ 快速测试」验证API连接
3. 确认模型名称正确
4. 如果使用本地模型，确保服务已启动

</details>

<details>
<summary><b>Q: TXT转世界书处理很慢？</b></summary>

这是正常现象：
- 每个记忆块需要调用一次AI API
- 大文件会被分割成多个记忆块
- 可以随时暂停，进度会自动保存
- 刷新页面后可以继续处理

</details>

<details>
<summary><b>Q: 世界书生成的内容不准确？</b></summary>

建议：
1. 使用更强的AI模型（如 gemini-2.5-flash）
2. 减小「每块字数」设置，让AI更专注
3. 使用「🔧 修复失败」重新处理失败的记忆块
4. 使用「🤖 AI优化」功能优化生成结果

</details>

---

## 📁 文件结构

```
novel-auto-generator/
├── manifest.json        # 扩展配置
├── index.js             # 主程序
├── txtToWorldbook.js    # TXT转世界书模块
├── style.css            # 样式表
└── README.md            # 说明文档
```

---

## 📝 更新日志

### v1.3.0
- ✨ **新增 TXT转世界书功能**，将TXT小说转换为SillyTavern世界书格式
- ✨ 支持多种AI API（Gemini、DeepSeek、Gemini代理、OpenAI兼容）
- ✨ 增量输出模式，智能更新世界书条目
- ✨ 记忆分裂机制，自动处理Token超限
- ✨ 完整的历史追踪与回滚功能
- ✨ AI优化世界书功能
- ✨ OpenAI兼容模式支持拉取模型列表和快速测试
- 🐛 修复弹窗背景过暗的问题
- 🐛 修复关闭弹窗导致插件栏折叠的问题
- 🐛 修复暂停功能不生效的问题
- 💄 优化弹窗UI，背景透明度调整为50%

### v1.2.0
- ✨ 全新高级设置 UI，三大模块清晰分隔（发送/回复/生成控制）
- ✨ 新增双阶段弹窗检测，分别兼容发送和回复阶段的插件
- 📱 完美适配移动端，帮助弹窗居中显示
- 🐛 修复移动端关闭弹窗导致插件栏折叠的问题
- 🐛 修复帮助弹窗背景透明的问题
- 💄 优化模块化 UI 设计，不同模块使用不同强调色
- 🔧 简化检测逻辑，提高稳定性

### v1.1.0
- ✨ 新增 DOM 稳定性检查，兼容总结等后处理插件
- ✨ 新增内置帮助系统，每个面板都有详细说明
- 🐛 修复帮助弹窗显示位置问题
- 💄 优化 UI 布局和交互体验

### v1.0.0
- 🎉 初始版本发布
- ⚡ 自动挂机生成功能
- 💾 断点续传支持
- 🏷️ 智能标签提取
- 📤 多格式导出

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

- 🐛 发现 Bug？请提 Issue
- 💡 有新想法？欢迎讨论
- 🔧 代码改进？请提 PR

---

## 📄 许可证

MIT License © 2024

---

<div align="center">

**Made with ❤️ for SillyTavern Community**

⭐ 如果这个插件对你有帮助，请给个 Star！


上面是原作者介绍 下面是我改的修改功能

移除了自动生成小说功能 


添加了epub转txt功能


Txt转世界书新代码相比原代码增加的所有功能：
# 📚 TXT转世界书 v2.9.2 完整新增功能介绍

---

## 一、API与处理模式

---

### 1️⃣ 酒馆API集成

**功能说明：**
- 新增「使用酒馆API」勾选项
- 勾选后直接使用SillyTavern当前连接的AI进行生成
- 无需单独配置API Key和Endpoint

**⚠️ 重要提示：**
- 调用酒馆API时**会加载你的预设**（包括System Prompt、Jailbreak、破限等）
- 如果预设里有角色扮演指令，可能会影响输出格式
- 建议：使用酒馆API时临时切换到干净的预设

---

### 2️⃣ 并行处理模式

**功能说明：**
- 新增「启用并行处理」开关
- 可设置并发数（1-10）
- 支持两种处理模式：

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| 🚀 独立模式 | 每章独立处理后合并，最快 | 章节关联性不强的小说 |
| 📦 分批模式 | 批次间累积上下文，更连贯 | 需要上下文连贯的小说 |

---

### 3️⃣ 分卷模式

**功能说明：**
- 新增「分卷模式」开关
- Token超限时自动开启新卷，而非分裂记忆
- 每卷独立保存世界书数据
- 支持分卷导出和合并导出

---

### 4️⃣ API超时设置

**功能说明：**
- 可配置API调用超时时间（默认120秒，范围30-600秒）
- 超时后自动重试或报错

---

### 5️⃣ API限流自动重试

**功能说明：**
- 遇到429限流错误自动指数退避重试
- 最多重试3次
- 重试间隔：1秒 → 2秒 → 4秒

---

## 二、章节与内容管理

---

### 6️⃣ 强制章节标记

**功能说明：**
- 新增「强制记忆为章节」勾选项
- **开启时**：强制AI将每个记忆块视为对应章节编号（记忆1=第1章，记忆2=第2章...）
- **关闭时**：AI根据原文中的章节信息自行处理
- 自动后处理：为剧情大纲/剧情节点条目添加章节编号后缀

---

### 7️⃣ 章回正则配置

**功能说明：**
- 可自定义章节检测正则表达式
- 内置快速选择：
  - 中文通用：`第[零一二三四五六七八九十百千万0-9]+[章回卷节部篇]`
  - 英文Chapter：`Chapter\s*\d+`
  - 数字章节：`第\d+章`
- 支持检测按钮预览匹配结果
- 支持重新分块按钮

---

### 8️⃣ 重Roll功能

**功能说明：**
- 每个记忆块支持多次生成
- 保存所有生成历史，可随时切换使用
- 支持自定义重Roll提示词（如"重点提取XX角色信息"）
- 操作方式：点击记忆块 → 🎲 Roll历史

---

### 9️⃣ 记忆编辑功能

点击任意记忆块可进行：
- 👁️ 查看原文内容
- ✏️ 编辑内容（实时显示字数）
- 📋 复制内容
- 🗑️ 删除记忆
- ⬆️ 合并到上一章
- ⬇️ 合并到下一章
- 🎲 查看Roll历史
- 📊 查看处理结果

---

### 🔟 起始位置选择

**功能说明：**
- 可选择从任意章节开始处理
- 显示每章状态（✅已完成/⏳待处理/❗失败）
- 支持跳过已处理的章节

---

### 1️⃣1️⃣ 多选删除模式（v2.9.2新增）

**功能说明：**
- 点击「🗑️ 多选删除」按钮进入多选模式
- 可勾选多个章节批量删除
- 显示已选数量
- 支持取消多选模式

---

## 三、世界书管理

---

### 1️⃣2️⃣ 分类灯状态管理

**功能说明：**
- 每个分类可独立设置灯状态
- 点击分类名称旁的灯图标切换
- 导出SillyTavern格式时自动应用

| 灯状态 | 含义 | 效果 |
|--------|------|------|
| 🔵 蓝灯 | 常驻 | constant=true, selective=false |
| 🟢 绿灯 | 触发式 | constant=false, selective=true |

**默认设置：**
- 🔵 蓝灯：角色、组织、知识书、文风配置
- 🟢 绿灯：地点、剧情大纲、地图环境、剧情节点

---

### 1️⃣3️⃣ 条目位置/深度/顺序配置（v2.9.2新增）

**功能说明：**
- 每个条目可单独配置：
  - **位置(Position)**：在角色定义之前/之后、在作者注释之前/之后、自定义深度
  - **深度(Depth)**：自定义深度时的数值（0-999）
  - **顺序(Order)**：数字越小越靠前（0-9999）
- 支持分类默认配置：设置后该分类下所有新条目继承此配置
- 导出时自动应用配置

---

### 1️⃣4️⃣ 世界书合并导入

**功能说明：**
- 支持导入已有的世界书JSON文件
- 自动识别内部格式和SillyTavern格式
- 可分别选择要导入的新条目和重复条目
- 支持按分类批量勾选
- 5种合并模式：

| 模式 | 说明 |
|------|------|
| 🤖 AI智能合并 | 使用AI合并同名条目，保留所有信息（支持并发） |
| 📝 覆盖原有 | 用导入内容直接覆盖 |
| 🔒 保留原有 | 跳过重复条目 |
| 📋 重命名添加 | 重复条目添加为新名称（如 角色名_导入） |
| ➕ 内容叠加 | 将新内容追加到原有条目后面 |

---

### 1️⃣5️⃣ 默认世界书条目UI化（v2.9.2新增）

**功能说明：**
- 可视化管理默认世界书条目
- 支持添加/编辑/删除条目
- 每个条目可配置：
  - 分类
  - 条目名称
  - 关键词
  - 内容
  - 位置/深度/顺序
- 转换完成后自动应用
- 支持手动「立即应用」

---

### 1️⃣6️⃣ 条目内容整理（支持多选分类）

**功能说明：**
- 点击「🧹 整理条目」按钮
- 弹出分类选择窗口，可多选要整理的分类
- 使用AI去除重复信息、合并相似描述
- 支持并行处理，显示进度

---

### 1️⃣7️⃣ 别名识别与合并（两两判断模式）

**功能说明：**
- 自动检测疑似同一角色的不同称呼
- 基于关键词交集和名称相似度
- AI两两配对判断是否同一人
- 自动合并确认的结果
- 显示详细的配对判断结果和合并方案

---

### 1️⃣8️⃣ 查找功能（v2.9.2新增）

**功能说明：**
- 点击「🔍 查找」按钮
- 输入要查找的内容（如乱码字符 �）
- 搜索世界书和处理结果中的内容
- 高亮显示匹配项
- 显示上下文便于定位

---

### 1️⃣9️⃣ 批量替换功能（v2.9.2新增）

**功能说明：**
- 点击「🔄 替换」按钮
- 输入查找内容和替换内容（留空则删除）
- 可选择替换范围：世界书/处理结果
- 支持预览替换效果
- 显示替换数量统计

---

## 四、自定义配置

---

### 2️⃣0️⃣ 自定义提取分类

**功能说明：**
- 预设分类：角色、地点、组织（内置）
- 可添加自定义分类：道具、玩法、章节剧情、角色内心等
- 每个分类可配置：
  - 分类名称
  - 条目名称示例
  - 关键词示例
  - 内容提取指南
- 支持启用/禁用单个分类
- 支持编辑/删除/重置单个分类
- 支持重置为默认配置
- 配置自动保存到IndexedDB

---

### 2️⃣1️⃣ 提示词配置

**功能说明：**
- **世界书词条**（必需）：核心提示词，支持占位符 `{DYNAMIC_JSON_TEMPLATE}`
- **剧情大纲**（可选）：勾选启用
- **文风配置**（可选）：勾选启用
- 每个部分都可自定义或使用默认
- 支持预览最终提示词
- 支持恢复默认

---

## 五、数据导入导出

---

### 2️⃣2️⃣ 任务状态导入/导出

**功能说明：**
- **导出**：保存完整任务状态
  - 记忆队列（含处理结果）
  - 世界书数据
  - 分卷数据
  - 所有设置
  - 并行配置
  - 灯状态配置
  - 自定义分类配置
  - 章回正则配置
  - 默认世界书条目
  - 条目位置配置
- **导入**：恢复任务继续处理
- 用途：中断后恢复、跨设备迁移、备份重要进度

---

### 2️⃣3️⃣ 设置导入/导出

**功能说明：**
- **导出**：保存所有配置
  - API设置
  - 提示词配置
  - 并行配置
  - 灯状态配置
  - 自定义分类配置
  - 章回正则配置
  - 默认世界书条目（UI数据）
  - 分类默认配置
  - 条目位置配置
- **导入**：快速恢复配置
- 用途：分享配置给他人、跨设备同步

---

### 2️⃣4️⃣ 多种导出格式

| 导出类型 | 说明 |
|----------|------|
| 📥 导出JSON | 导出内部格式世界书 |
| 📦 分卷导出 | 分卷模式下逐卷导出 |
| 📥 导出SillyTavern格式 | 转换为ST世界书格式（应用灯状态和位置配置） |

---

## 六、界面与交互

---

### 2️⃣5️⃣ 实时输出面板

**功能说明：**
- 显示API调用过程
- 显示响应内容
- 显示错误信息
- 支持显示/隐藏切换
- 支持清空内容

---

### 2️⃣6️⃣ 已处理结果查看

**功能说明：**
- 点击「📊 已处理」按钮
- 左侧显示所有已处理章节列表
- 右侧显示选中章节的详细结果
- 支持复制结果

---

### 2️⃣7️⃣ 世界书详细视图

**功能说明：**
- 点击「📖 查看世界书」按钮
- 分类卡片式展示
- 支持展开/收起分类和条目
- 显示灯状态并支持切换
- 显示条目位置/深度/顺序配置
- 支持配置单个条目和分类默认

---

### 2️⃣8️⃣ 修改历史查看

**功能说明：**
- 点击「📜 修改历史」按钮
- 左侧显示历史记录列表
- 右侧显示变更详情
- 支持回退到历史版本
- 支持导出历史版本的世界书
- 支持清空历史
- 支持条目演变分析
- 支持AI优化世界书

---

### 2️⃣9️⃣ 帮助弹窗

**功能说明：**
- 点击 ❓ 按钮显示帮助
- 包含基本功能介绍
- 版本更新说明
- API模式说明
- 使用技巧

---

## 七、技术改进

---

| 功能 | 说明 |
|------|------|
| **ST格式转换** | 导入SillyTavern格式世界书自动转换为内部格式 |
| **重复历史清理** | 自动清理重复的历史记录 |
| **上下文传递** | 获取上一章剧情摘要传递给当前章 |
| **智能章节切分** | 改进切分算法，避免过小章节，合并小章节 |
| **处理状态指示** | 记忆块显示🔄处理中状态 |
| **字数实时统计** | 编辑记忆时显示实时字符数 |
| **Gemini安全设置** | 调用时设置所有安全类别为OFF |
| **模型下拉选择** | OpenAI兼容模式拉取模型后显示下拉框 |
| **快速测试** | 发送"Hi"测试模型连接 |
| **信号量并发控制** | 使用Semaphore类控制并发任务 |
| **并发任务追踪** | 追踪活跃的并行任务 |
| **Token超限检测** | 多种模式检测Token超限错误 |
| **JSON多层解析** | 直接解析 → 清理解析 → 补括号 → 正则提取 |
| **编码自动检测** | 支持UTF-8、GBK、GB2312、GB18030、Big5 |
| **文件哈希计算** | 支持Web Crypto API和简易哈希回退 |
| **状态持久化** | 使用IndexedDB保存历史、状态、配置 |

---

## 八、公开API列表

```javascript
window.TxtToWorldbook = {
    // 基础操作
    open,                           // 打开弹窗
    close,                          // 关闭弹窗

    // 数据获取
    getWorldbook,                   // 获取当前世界书
    getMemoryQueue,                 // 获取记忆队列
    getVolumes,                     // 获取分卷数据
    getAllVolumesWorldbook,         // 获取合并后的世界书
    getSettings,                    // 获取设置
    getParallelConfig,              // 获取并行配置
    getCategoryLightSettings,       // 获取灯状态配置
    getCustomCategories,            // 获取自定义分类配置
    getEnabledCategories,           // 获取启用的分类
    getChapterRegexSettings,        // 获取章回正则配置
    getDefaultWorldbookEntriesUI,   // 获取默认世界书条目UI数据
    getEntryConfig,                 // 获取条目配置

    // 任务管理
    exportTaskState,                // 导出任务状态
    importTaskState,                // 导入任务状态
    exportSettings,                 // 导出设置
    importSettings,                 // 导入设置

    // 功能操作
    rerollMemory,                   // 重Roll指定记忆
    showRollHistory,                // 显示Roll历史
    importAndMerge,                 // 导入合并世界书
    setCategoryLight,               // 设置分类灯状态
    rebuildWorldbook,               // 从记忆重建世界书
    applyDefaultWorldbook,          // 应用默认条目
    rechunkMemories,                // 重新分块
    showConsolidateCategorySelector,// 显示整理分类选择器
    showAliasMergeUI,               // 显示别名合并UI
    showSearchModal,                // 显示查找弹窗
    showReplaceModal,               // 显示替换弹窗
    setEntryConfig,                 // 设置条目配置
    setCategoryDefaultConfig,       // 设置分类默认配置

    // API调用
    callCustomAPI,                  // 调用自定义API
    callSillyTavernAPI,             // 调用酒馆API

    // 内部函数
    _rollbackToHistory              // 回滚到历史版本
};
```

---

## 九、使用建议

---

### 关于「使用酒馆API」

| 场景 | 建议 |
|------|------|
| 想用酒馆连接的API | ✅ 勾选，但注意预设会生效 |
| 预设有角色扮演指令 | ⚠️ 临时切换到干净预设 |
| 想完全控制提示词 | ❌ 不勾选，使用自定义API |

---

### 关于「强制章节标记」

| 场景 | 建议 |
|------|------|
| 原文没有章节信息 | ✅ 开启，统一按记忆序号标记 |
| 原文有明确章节 | ❌ 关闭，让AI自行识别 |
| 章节信息混乱 | ✅ 开启，强制统一 |

---

### 关于「并行处理」

| 场景 | 建议 |
|------|------|
| 章节独立性强 | ✅ 独立模式，最快 |
| 需要上下文连贯 | 📦 分批模式 |
| API有严格限流 | 降低并发数或关闭并行 |

---

### 关于「条目配置」

| 需求 | 配置建议 |
|------|----------|
| 角色信息优先显示 | Position=0（角色定义前），Order=10 |
| 背景设定次要 | Position=1（角色定义后），Order=50 |
| 触发式信息 | Position=4（自定义深度），Depth=4 |

---

以上就是TXT转世界书 v2.9.2 的完整新增功能介绍！ (ﾉ>ω<)ﾉ
</div>
